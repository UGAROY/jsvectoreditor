/*
  jsvectoreditor 1.0.0 <https://github.com/UGAROY/jsvectoreditor>
  Copyright (c) 2015 

 */
(function(a,b){var c=function(a,b){var c=b.indexOf(a);-1!==c?b.splice(a,1):0},d=(Raphael.format,function(c){var d=b(c).offset(),e=b(a).scrollTop(),f=b(a).scrollLeft();return[d.left-f,d.top-e]}),e=function(a){a.preventDefault();var b=a.data.currentEditor,c=d(this);2===a.button&&b.setMode("select"),b.onMouseDown(a.clientX-c[0],a.clientY-c[1],a.target)},f=function(a){a.preventDefault();var b=a.data.currentEditor,c=d(this);b.onMouseUp(a.clientX-c[0],a.clientY-c[1],a.target)},g=function(a){a.preventDefault();var b=a.data.currentEditor,c=d(this);b.onMouseMove(a.clientX-c[0],a.clientY-c[1],a.target)},h=function(a){var b=a.data.currentEditor,c=d(this);b.onDblClick(a.clientX-c[0],a.clientY-c[1],a.target)};a.VectorEditor=function(a,c,d){if("function"!=typeof Raphael)return alert("Error! Renderer is Missing!");this.container=a,this.paper=Raphael(a,c,d),this.paper.editor=this,this.onHitXY=[0,0],this.tmpXY=[0,0],this.prop={src:"http://upload.wikimedia.org/wikipedia/commons/a/a5/ComplexSinInATimeAxe.gif","stroke-width":1,stroke:"#000000",fill:"#ff0000","stroke-opacity":1,"fill-opacity":1,text:"Text"},this.mode="select",this.selectbox=null,this.selected=[],this.action="",this.selectadd=!1,this.shapes=[],this.trackers=[],this.listeners={};var i=this;b(a).off("mousedown",e),b(a).off("mousemove",g),b(a).off("mouseup",f),b(a).off("dblclick",h),b(a).on("mousedown",{currentEditor:i},e),b(a).on("mouseup",{currentEditor:i},f),b(a).on("mousemove",{currentEditor:i},g),b(a).on("dblclick",{currentEditor:i},h)},VectorEditor.prototype.setMode=function(a){"delete"===a?(this.deleteSelection(),this.mode="select"):(this.unselect(),this.mode=a)},VectorEditor.prototype.returnRotatedPoint=function(a,b,c,d,e){var f=Math.sqrt((a-c)*(a-c)+(b-d)*(b-d)),g=Math.atan2(b-d,a-c)*(180/Math.PI),h=f*Math.cos((e+g)/(180/Math.PI)),i=f*Math.sin((e+g)/(180/Math.PI));return[c+h,d+i]},VectorEditor.prototype.is_selected=function(a){return-1!==this.selected.indexOf(a)},VectorEditor.prototype.set_attr=function(){for(var a=0;a<this.selected.length;a++)this.selected[a].attr.apply(this.selected[a],arguments)},VectorEditor.prototype.set=function(a,b){this.prop[a]=b,this.set_attr(a,b)},VectorEditor.prototype.onMouseDown=function(a,b,c){if(this.starteMouseEvent=!0,this.tmpXY=this.onHitXY=[a,b],"select"===this.mode){var d;if(c.shape_object)d=c.shape_object;else{if(!c.parentNode.shape_object)return c.is_tracker?void 0:void this.unselect();d=c.parentNode.shape_object}this.is_selected(d)?this.action="move":(this.select(d),this.action="move")}else{var e;"rect"===this.mode?(e=this.paper.rect(0,0,0,0),e.translate(a,b)):"ellipse"===this.mode?(e=this.paper.ellipse(0,0,0,0),e.translate(a,b)):"path"===this.mode?e=this.paper.path("M{0},{1}",a,b):"line"===this.mode?(e=this.paper.path("M{0},{1}",a,b),e.subtype="line"):"polygon"===this.mode?(e=this.paper.path("M{0},{1}",a,b),e.polypoints=[[a,b]],e.subtype="polygon"):"image"===this.mode?e=this.paper.image(this.prop.src,0,0,0,0):"text"===this.mode&&(e=this.paper.text(0,0,this.prop.text).attr("font-size",0),e.text=this.prop.text),e&&(e.id=this.generateUUID(),e.attr({fill:this.prop.fill,stroke:this.prop.stroke,"stroke-width":this.prop["stroke-width"],"fill-opacity":this.prop["fill-opacity"],"stroke-opacity":this.prop["stroke-opacity"]}),this.addShape(e))}return!1},VectorEditor.prototype.onMouseMove=function(a,b,c){if(this.starteMouseEvent){if("select"===this.mode){if("move"===this.action){for(var d=0;d<this.selected.length;d++)this.move(this.selected[d],a-this.tmpXY[0],b-this.tmpXY[1]);this.updateTracker(),this.tmpXY=[a,b]}else if("rotate"===this.action){var e=this.selected[0],f=e.getBBox(),g=Math.atan2(b-(f.y+f.height/2),a-(f.x+f.width/2)),h=((g*(180/Math.PI)+90)%360+360)%360;this.rotate(this.selected[0],h),this.updateTracker()}else if("path"===this.action.substr(0,4)){var i=parseInt(this.action.substr(4)),j=Raphael.parsePathString(this.selected[0].attr("path"));j[i]&&(j[i][1]=a,j[i][2]=b,this.selected[0].attr("path",j),this.updateTracker())}else if("resize"===this.action){if(!this.onGrabXY){var f=this.selected[0].getBBox();"ellipse"===this.selected[0].type?this.onGrabXY=[f.x,f.y]:"path"===this.selected[0].type?this.onGrabXY=[f.x,f.y,f.width,f.height]:this.onGrabXY=[f.x,f.y]}var f=this.selected[0].getBBox(!0),k=this.returnRotatedPoint(a,b,f.x+f.width/2,f.y+f.height/2,-this.selected[0].matrix.split().rotate);a=k[0]-5,b=k[1]-5;var e=this.selected[0];this.resize(e,a,b,this.onGrabXY),this.newTracker(this.selected[0])}}else{var e=this.selected[0];if("rect"===this.mode||"image"===this.mode||"ellipse"===this.mode||"text"===this.mode)this.resize(e,a,b,this.onHitXY);else if("path"===this.mode)this.selected[0].attr("path",this.selected[0].attrs.path+"L"+a+" "+b);else if("polygon"===this.mode||"line"===this.mode){var j=Raphael.parsePathString(this.selected[0].attr("path"));if(j.length>1){if("line"===this.mode)console.log(j),j.splice(1);else{j[j.length-1];this.selected[0].polypoints.length<j.length&&j.splice(j.length-1,1)}this.selected[0].attr("path",j.toString()+"L"+a+" "+b)}else this.selected[0].attr("path",this.selected[0].attrs.path+"L"+a+" "+b)}}return!1}},VectorEditor.prototype.getMarkup=function(){return this.paper.canvas.parentNode.innerHTML},VectorEditor.prototype.onDblClick=function(a,b,c){return this.fire("dblclick"),1===this.selected.length&&(0===this.selected[0].getBBox().height&&0===this.selected[0].getBBox().width&&this.deleteShape(this.selected[0]),"polygon"===this.mode&&this.unselect()),!1},VectorEditor.prototype.onMouseUp=function(a,b,c){if(this.starteMouseEvent=!1,this.onGrabXY=null,this.selected[0]&&this.applyTransforms(this.selected[0]),"select"===this.mode||"delete"===this.mode)if(this.selectbox){for(var d=this.selectbox.getBBox(),e=[],f=0;f<this.shapes.length;f++)this.rectsIntersect(this.shapes[f].getBBox(),d)&&e.push(this.shapes[f]);if((0===e.length||this.selectadd===!1)&&this.unselect(),1===e.length&&this.selectadd===!1)this.select(e[0]);else for(var f=0;f<e.length;f++)this.selectAdd(e[f]);this.selectbox.node.parentNode&&this.selectbox.remove(),this.selectbox=null,"delete"===this.mode&&this.deleteSelection()}else this.action="";else 1===this.selected.length&&(0===this.selected[0].getBBox().height&&0===this.selected[0].getBBox().width&&"polygon"!==this.selected[0].subtype&&this.deleteShape(this.selected[0]),"rect"===this.mode?this.unselect():"ellipse"===this.mode?this.unselect():"path"===this.mode?this.unselect():"line"===this.mode?this.unselect():"image"===this.mode?this.unselect():"text"===this.mode?this.unselect():"polygon"===this.mode&&(this.selected[0].attr("path",this.selected[0].attrs.path+"L"+a+" "+b),this.selected[0].polypoints||(this.selected[0].polypoints=[]),this.selected[0].polypoints.push([a,b])));return this.lastmode&&(this.setMode(this.lastmode),delete this.lastmode),!1},VectorEditor.prototype.on=function(a,b){this.listeners[a]||(this.listeners[a]=[]),-1!==this.listeners[a].indexOf(b)&&this.listeners[a].push(b)},VectorEditor.prototype.fire=function(a){if(this.listeners[a])for(var b=0;b<this.listeners[a].length;b++)if(this.listeners[a][b].apply(this,arguments)===!1)return!1},VectorEditor.prototype.un=function(a,b){if(this.listeners[a])for(var c=0;-1!==(c=this.listeners[a].indexOf(b));)this.listeners[a].splice(c,1)},VectorEditor.prototype.deleteSelection=function(){for(;this.selected.length>0;)this.deleteShape(this.selected[0])},VectorEditor.prototype.deleteShape=function(a,b){if(b||this.fire("delete",a)!==!1){a&&a.node&&a.node.parentNode&&a.remove();for(var c=0;c<this.trackers.length;c++)this.trackers[c].shape===a&&this.removeTracker(this.trackers[c]);for(var c=0;c<this.shapes.length;c++)this.shapes[c]===a&&this.shapes.splice(c,1);for(var c=0;c<this.selected.length;c++)this.selected[c]===a&&this.selected.splice(c,1)}},VectorEditor.prototype.deleteAll=function(){this.paper.clear(),this.shapes=[],this.trackers=[]},VectorEditor.prototype.clearShapes=function(){for(;this.shapes.length>0;)this.deleteShape(this.shapes[0],!0)},VectorEditor.prototype.generateUUID=function(){for(var a="",b="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",c=0;4>c;c++)a+=b.charAt(Math.floor(Math.random()*(c?b.length:b.length-10)));return a},VectorEditor.prototype.getShapeById=function(a){for(var b=this.shapes.length;b--&&this.shapes[b].id!==a;);return this.shapes[b]},VectorEditor.prototype.addShape=function(a,b,c){c||this.fire("addshape",a,b),a.node.shape_object=a,b||(this.selected=[a]),this.shapes.push(a),c||this.fire("addedshape",a,b)},VectorEditor.prototype.rectsIntersect=function(a,b){return b.x<a.x+a.width&&b.x+b.width>a.x&&b.y<a.y+a.height&&b.y+b.height>a.y},VectorEditor.prototype.drawGrid=function(){this.paper.drawGrid(0,0,480,272,10,10,"blue").toBack()},VectorEditor.prototype.move=function(a,b,c){"rect"===a.type||"image"===a.type||"ellipse"===a.type?a.transform(Raphael.format("...t{0},{1}",b,c)):"path"===a.type&&(a.transform(Raphael.format("...t{0},{1}",b,c)),console.log("move",a.attr("path"))),this.renormalizeRotation(a)},VectorEditor.prototype.applyTransforms=function(a){if("path"===a.type){for(var b=[],c=[],d=a.transform(),e=0;e<d.length;e++)"r"!==d[e][0]?b.push(d[e]):c.push(d[e]);for(var f=Raphael.transformPath(a.attr("path"),b),e=0;e<f.length;e++)"C"===f[e][0]&&(f[e]=["L",f[e][5],f[e][6]]);a.attr("path",f),a.transform(c)}},VectorEditor.prototype.fixText=function(b){return a.Ax?Ax.textfix(b):b},VectorEditor.prototype.except=function(a,b){console.log(b);for(var c=[],d=0;d<b.length;d++)b[d][0]!==a&&c.push(b[d]);return c},VectorEditor.prototype.renormalizeRotation=function(a){for(var b=a.transform(),c=[],d=0,e=0;e<b.length;e++)"r"===b[e][0]?d+=b[e][1]:c.push(b[e]);a.transform(""),a.transform(c),a.rotate(d)},VectorEditor.prototype.rotate=function(a,b){a.transform(""),a.rotate(b)},VectorEditor.prototype.resize=function(a,b,c,d){var e=d[0],f=d[1],g=b-e,h=c-f;if(!(0>g||0>h))if("rect"===a.type||"image"===a.type)a.attr("width",g),a.attr("height",h);else if("ellipse"===a.type)a.attr("cx",g/2),a.attr("cy",h/2),a.attr("rx",g/2),a.attr("ry",h/2);else if("text"===a.type)a.attr("font-size",Math.abs(g));else if("path"===a.type){var i=this.except("s",a.transform());i.unshift(["s",g/d[2],h/d[3],e,f]),a.transform(i)}},VectorEditor.prototype.unselect=function(a){if(a){this.fire("unselect",a),c(a,this.selected);for(var b=0;b<this.trackers.length;b++)this.trackers[b].shape===a&&this.removeTracker(this.trackers[b])}else{for(;this.selected[0];)this.unselect(this.selected[0]);a!==!1&&this.fire("unselected")}},VectorEditor.prototype.selectAdd=function(a){if(this.is_selected(a)===!1){if(this.fire("selectadd",a)===!1)return;this.selected.push(a),this.showGroupTracker(a)}},VectorEditor.prototype.selectAll=function(){this.unselect();for(var a=0;a<this.shapes.length;a++)this.selectAdd(this.shapes[a])},VectorEditor.prototype.selectToggle=function(a){this.is_selected(a)===!1?this.selectAdd(a):this.unselect(a)},VectorEditor.prototype.select=function(a){this.fire("select",a)!==!1&&(this.unselect(!1),this.selected=[a],this.showTracker(a))},VectorEditor.prototype.removeTracker=function(a){if(a)a.remove(),c(a,this.trackers);else for(;this.trackers.length>0;)this.removeTracker(this.trackers[0])},VectorEditor.prototype.updateTracker=function(a){if(a){var b=a.shape;b._.dirty=!0;var c=b.getBBox(!0);if(console.log("box",c),"path"===b.type){var d=Raphael.parsePathString(b.attr("path"));2===d.length?(a[0].attr({cx:c.x+c.width/2,cy:c.y+c.height/2}),a[1].attr({x:d[0][1]-2,y:d[0][2]-2}),a[2].attr({x:d[1][1]-2,y:d[1][2]-2})):(a[0].attr({cx:c.x+c.width/2,cy:c.y+c.height/2}),a[1].attr({x:c.x-6,y:c.y-6}),a[2].attr({x:c.x+c.width,y:c.y+c.height}))}a.transform(b.matrix.toTransformString())}else for(var e=0;e<this.trackers.length;e++)this.updateTracker(this.trackers[e])},VectorEditor.prototype.trackerBox=function(a,b,c){var d=4,e=this.paper.rect(a-d,b-d,2*d,2*d).attr({"stroke-width":1,stroke:"green",fill:"white"}).mouseover(function(){this.attr("fill","red")}).mouseout(function(){this.attr("fill","white")}).mousedown(function(a){this.paper&&this.paper.editor&&(this.paper.editor.action=c)});return e.node.is_tracker=!0,e},VectorEditor.prototype.trackerCircle=function(a,b){return},VectorEditor.prototype.hideTooltip=function(){this.tt&&this.tt.hide()},VectorEditor.prototype.markTracker=function(a){return a.node.is_tracker=!0,a},VectorEditor.prototype.newTracker=function(a){for(var b=0;b<this.trackers.length;b++)this.trackers[b].shape===a&&this.removeTracker(this.trackers[b]);this.showTracker(a)},VectorEditor.prototype.showTracker=function(a){var b=-14,c=a.getBBox(!0);console.log(c);var d=this.paper.set();if(d.shape=a,d.lastx=0,d.lasty=0,d.push(this.markTracker(this.paper.ellipse(c.width/2,c.height/2,7,7).attr({stroke:"gray","stroke-opacity":.5,fill:"gray","fill-opacity":.15})).mousedown(function(){this.paper.editor.action="move"})),"line"===a.subtype){var e=Raphael.parsePathString(a.attr("path"));d.push(this.trackerBox(e[0][1]-c.x,e[0][2]-c.y,"path0")),d.push(this.trackerBox(e[1][1]-c.x,e[1][2]-c.y,"path1")),this.trackers.push(d)}else"rect"===a.type||"image"===a.type?(d.push(this.paper.rect(-6,-6,c.width+11,c.height+11).attr({opacity:.3})),d.push(this.trackerCircle(c.width/2,b)),d.push(this.trackerBox(c.width+5,c.height+5,"resize")),this.trackers.push(d)):"ellipse"===a.type?(d.push(this.trackerCircle(c.width/2,b)),d.push(this.trackerBox(c.width+5,c.height+5,"resize")),this.trackers.push(d)):"text"===a.type?(d.push(this.paper.rect(-6,-6,c.width+11,c.height+11).attr({opacity:.3})),d.push(this.trackerCircle(c.width/2,b)),d.push(this.trackerBox(c.width+5,c.height+5,"resize")),this.trackers.push(d)):"path"===a.type&&"line"!==a.subtype?(d.push(this.paper.rect(-6,-6,c.width+11,c.height+11).attr({opacity:.3})),d.push(this.trackerBox(c.width+5,c.height+5,"resize")),d.push(this.trackerCircle(c.width/2,b)),this.trackers.push(d)):(d.push(this.paper.rect(-6,-6,c.width+11,c.height+11).attr({opacity:.3})),d.push(this.trackerCircle(c.width/2,b)),this.trackers.push(d));this.updateTracker(d)},VectorEditor.prototype.showGroupTracker=function(a){var b=this.paper.set(),c=a.getBBox();b.push(this.markTracker(this.paper.ellipse(c.width/2,c.height/2,7,7).attr({stroke:"gray","stroke-opacity":.5,fill:"gray","fill-opacity":.15})).mousedown(function(){this.paper.editor.action="move"})),b.push(this.paper.rect(-6,-6,c.width+11,c.height+11).attr({"stroke-dasharray":"-",stroke:"blue"})),b.shape=a,b.lastx=0,b.lasty=0,this.trackers.push(b),this.updateTracker(b)}}).call({},window,window.$||(window.angular||{}).element);